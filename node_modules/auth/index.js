var domain = require('domain');
var fs = require('fs');
var aws = require('aws');
var crypto = require('crypto');

var util = require('./util');

module.exports.authorize = authorize;
module.exports.associate = associate;
module.exports.authorizations = authorizations;
module.exports.decode = decode;
module.exports.middleware = middleware;
module.exports.access = function (name, yes_or_no) {
    access[name] = yes_or_no === true;
}

var access = {};

var secret = "asdfjkasldfkja;sdlk;alksj df;lasjdl";

var authenticated = {}; //  encrypted session tokens to email user with them;
var pending_tokens = {};

var associations = new Map();

function authorize(operation, authorization, field, value) {
    //  reference access for watching is throwing some error...
    return true;

    //  agents is a list of agents who are involved with this operation
    //  operation is the type of operation authorization is requested for
    //  authorization is the object to resolve authorization for
    //  field is the field the operation is requested for
    var auth_list =  authorizations();
    if (auth_list.length) {
//        console.log(operation, field, 'authorizations :', auth_list);

        var last_requester = auth_list[auth_list.length-1];
        if (access[last_requester]) {
            //  is last requester has been given specific access, allow access
        }
        else if (typeof authorization == 'function') {
            if (authorization(auth_list, field, value) !== true) {
                throw new Error('Access function denied access');
            }
        }
        else if (typeof authorization == 'string') {
            if (auth_list[auth_list.length - 1] !== authorization) {
                throw new Error('Access string denied access');
            }
        }
        else {
            throw new Error('Access denied');
        }
    }
    else {
        //  no authorization required because no agents in auth_list
    }
}

function associate(agent) {
    if (domain.active) {
        if (domain.active.authorizations == undefined) {
//            console.log('!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! new', domain.active.name);
            domain.active.authorizations = [];
        }
        domain.active.authorizations.push(agent);
    }
}

function authorizations() {
    if (domain.active && domain.active.authorizations) {
        return domain.active.authorizations.slice(0);
    }
    else {
        return [];
    }
}

//  transform an authorization token into the username 
function decode(token) {
    var parts = token.split('|');
    var decoded = 'anonymous';
    if (parts[2] === encrypt(parts[0] + '|' + parts[1] + '|' + secret)) {
        decoded = parts[0];
    }
    return decoded;
}

var client = fs.readFileSync(__dirname + '/client.html').toString();
client = client.replace('SCRIPT', fs.readFileSync(__dirname + '/client.js').toString())


function parseCookies (request) {
    var list = {};
    var rc = request.headers.cookie;

    rc && rc.split(';').forEach(function( cookie ) {
        var parts = cookie.split('=');
        list[parts.shift().trim()] = unescape(parts.join('='));
    });

    return list;
}

function send_email(from, to, subject, message, callback) {
    aws.ses.sendEmail({
        Source : from,
        Destination : {
            ToAddresses : [to]
        },
        Message : {
            Body : {
                Text : {
                    Data : message,
                    Charset : "UTF8"
                }
            },
            Subject : {
                Data : subject
            }
        }
    }, function (err, data) {
        callback(err);
    });
}

function encrypt(token) {
    return crypto.createHash('sha256').update(token).digest('base64');
}

function middleware(req, res, next) {

    var subdomain = req.headers.host.split('.').shift();
    var host = req.headers.host;
    var cookies = parseCookies(req);
    var id = cookies.id;
    if (id == undefined) {
        //  save encrypted token as a key in storage
        res.setHeader('Access-Control-Allow-Origin', 'http://' + host.split('.').slice(1).join('.'));
        res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');
        res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With,content-type');
        res.setHeader('Access-Control-Allow-Credentials', true);
        id = util.random_string(32);
        res.setHeader('Set-Cookie', 'id=' + id + ';domain=.' + host.split('.').slice(1).join('.'));
        cookies.id = id;
    }

    if (subdomain == 'auth') {
        if (req.method === 'GET') {
            if (req.path == '/') {
                res.end(client);
            }
            else {
                //  authenticate the current user with the given url
                var token = req.path.substring(1);
                if (pending_tokens[token]) {
                    var data = pending_tokens[token];
                    var credential = encrypt(token + '|' + id);
                    if (credential === data.credential) {
                        authenticated[encrypt(id)] = data.email;
                        var salt = util.random_string(8);
                        var encoded = data.email + '|' + salt + '|' + encrypt(data.email + '|' + salt + '|' + secret);
                        res.setHeader('Set-Cookie', 'id=' + encoded + ';domain=.' + host.split('.').slice(1).join('.'));
                        res.end();
                    }
                    else {
                        res.end('invalid login');
                    }
                }
                else {
                    res.end(client);
                }
            }
        }
        else if (req.method === 'POST') {
            var body = '';
            req.on('data', function (data) {
                body += data;

                // Too much POST data, kill the connection!
                if (body.length > 1e6)
                    req.connection.destroy();
            });
            req.on('end', function () {
                // authenticate 
                try {
                    var data = JSON.parse(body);
                    var email_string = util.random_string(8);
                    var email = "http://" + host + '/' + email_string;
                    console.log(email);
                    var subject = "ol-c account access";
                    //  TODO: add email string to client credential
                    //  add to pending auth list with expires and username
                    var encrypted_credential = encrypt(email_string + "|" + id);
                    pending_tokens[email_string] = {
                        email   : data.email,
                        created : new Date(),
                        credential : encrypted_credential
                    };
                    send_email('accounts@ol-c.com', data.email, subject, email, function (err, data) {
                        if (err) res.statusCode = 500;
                        res.end();
                    });
                }
                catch (error) {
                    console.log(error);
                    res.statusCode = 400; // "bad request"
                    res.end();
                }
            });
        }
        else {
            res.statusCode = 405;
            res.end();
        }
    }
    else {
        next();
    }
}
