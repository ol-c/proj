var domain = require('domain');

module.exports.check = check;
module.exports.associate = associate;
module.exports.authorizations = authorizations;
module.exports.decode = decode;

var associations = new Map();

function check(operation, authorization, field) {
    //  agents is a list of agents who are involved with this operation
    //  operation is the type of operation authorization is requested for
    //  authorization is the object to resolve authorization for
    //  field is the field the operation is requested for
    if (domain.active) {
        console.log(operation, field, 'authorizations :', domain.active.authorizations);
        if (field == 'protected') {
            throw new Error('No one has access to the "protected" regions!');
        }
    }
    else {
    //    console.log('no active authorizations');
    }
}

function associate(agent) {
    if (domain.active) {
        if (domain.active.authorizations == undefined) {
//            console.log('!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! new', domain.active.name);
            domain.active.authorizations = [];
         }
         domain.active.authorizations.push(agent);
    }
}

function authorizations() {
    if (domain.active && domain.active.authorizations) {
        return domain.active.authorizations.slice(0);
    }
    else {
        return [];
    }
}

//  transform an authorization token into the username 
function decode(token) {
    var decoded = 'anonymous';
    if (token) {
        decoded = 'resolved authorization token...';
    }
    return decoded;
}
