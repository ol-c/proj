module.exports.client = client;
var persist = require('persist');
var references = require('references');


var clientized = function () {
    ENVIRONMENT 
    var fn = CLIENT;
    fn();
};

//  returns a function that can be executed on the client and
//  has access to remote functions
function client(client_fn, remote_fns) {
    //  TODO: ensure all remote functions are references to functions

    var environment = '';

    for (var fn in remote_fns) {
        //  TODO: return promise and execute remote function
        //  TODO: add code to add the arguments to the function to the
        environment += 'var reference = ' + JSON.stringify(references.serializable(remote_fns[fn])) + '\n'
                    +  '    reference.push({type : "call", name : "*"});\n'
                    +  '    var ' + fn + ' = function () {\n'
                    +  '        var args = [];\n'
                    +  '        reference[reference.length-1].arguments = args;\n'
                    +  '        for (var i=0; i<arguments.length; i++) args.push(serializable_from_instance(arguments[i]));\n'
                    +  '        resolve_reference(reference, function (result) {console.log("resolve promise with:", result)}); return {then : function (fn) {}}\n'
                    +  '    }\n'
    }

    //  TODO: client side logging and error handling...

    var serialized = 'serialized = ' + clientized.toString()
        .replace('ENVIRONMENT', environment)
        .replace('CLIENT', client_fn.toString());

    eval(serialized);

    return serialized;
}
