module.exports = html

var persist = require('persist');
var references = require('references')

function html(tag, attributes, css, content) {
    if (!/^[a-zA-Z0-9]+$/.test(tag)) {
        return '<span style="color:red">Invalid tag name [TODO: insert tag name]</span>'
    }
    
    var processed_content;
    try {processed_content = persist.serializable_from_instance(content);}
    catch (error) {processed_content = persist.serializable_from_instance(error);}
    
    //  Apply necesary code and remove script element
    function onload() {
        var id = ID;
        var css = CSS;
        var attr = ATTR;
        var content = CONTENT;
        var element = $("#" + id);
        var script = $("#" + id + 'script');
        $(function () {
            for (var field in css) {
                bind_css(element, field, css[field]);
            }
            for (var field in attr) {
                bind_attribute(element, field, attr[field])
            }
            console.log('before binding', element, content);
            bind_html(element, content);
        });
        element.removeAttr('id');
        script.remove();
    }

    function serialize_fields(from, into) {
        for (var field in from) {
            try {into[field] = persist.serializable_from_instance(from[field]);}
            catch (error) {} // should never error since persistant objects can only have serializable values
        }
    }

    var id = "tmp_" + (Math.random() + '').slice(2);
    var new_css = {};
    serialize_fields(css, new_css)
    css = new_css;
    
    var new_attr = {};
    serialize_fields(attributes, new_attr);
    attributes = new_attr;
    onload = '(' + onload.toString()
        .replace('CSS', JSON.stringify(css))
        .replace("ATTR", JSON.stringify(attributes))
        .replace("CONTENT", JSON.stringify(processed_content))
        .replace("ID", '"'  + id + '"') + ')()';
    var script = '<script id="' + id + 'script" type="text/javascript">' + onload + '</script>'
    return '<' + tag + ' id="' + id + '"></' + tag + '>' + script
};
