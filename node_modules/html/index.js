module.exports = html;

var persist = require('persist');
var references = require('references');

function html(tag, attributes, content) {
    if (!/^[a-zA-Z0-9]+$/.test(tag)) {
        return '<span style="color:red">Invalid tag name [TODO: insert tag name]</span>';
    }
    
    var processed_content;
    try {processed_content = persist.serializable_from_instance(content);}
    catch (error) {processed_content = persist.serializable_from_instance(error);}
    
    //  Apply necesary code and remove script element
    function client() {
        var id = ID;
        var attr = ATTR;
        var content = CONTENT;
        var element = $("#" + id);
        var script = $("#" + id + 'script');
        $(function () {
            var field;
            for (field in attr) {
                bind_attribute(element, field, attr[field]);
            }
            bind_html(element, content);
        });
        element.removeAttr('id');
        script.remove();
    }

    function serialize_attributes(from, into) {
        for (var field in from) {
            //  style value may be an object for css reasons
            if (field == 'style') {
                into.style = {};
                serialize_attributes(from.style, into.style);
            }
            else {
                // TODO: somehow warn object not valid
                try {into[field] = persist.serializable_from_instance(from[field]);}
                catch (error) {}            }
        }
    }

    var id = "tmp_" + (Math.random() + '').slice(2);

    var new_attr = {};
    serialize_attributes(attributes, new_attr);
    attributes = new_attr;
    var client_source = '(' + client.toString()
        .replace("ATTR", JSON.stringify(attributes))
        .replace("CONTENT", JSON.stringify(processed_content))
        .replace("ID", '"'  + id + '"') + ')()';
    var script = '<script id="' + id + 'script" type="text/javascript">' + client_source + '</script>';
    return '<' + tag + ' id="' + id + '"></' + tag + '>' + script;
}
