module.exports = html;

var persist = require('persist');
var references = require('references');

function html(tag, attributes, content) {
    if (!/^[a-zA-Z0-9]+$/.test(tag)) {
        return '<span style="color:red">Invalid tag name [TODO: insert tag name]</span>';
    }
    
    var processed_content;
    try {
        if (persist.is(content)) {
            var render = content.render;
            if (persist.get_type(render) == 'function') {
                processed_content = persist.serializable_from_instance(render());
            }
            else if (persist.get_type(render) == 'reference') {
                processed_content = persist.serializable_from_instance(render);
            }
            else {
                processed_content = {type : 'string', data : 'invalid renderer for an object'};
            }
        }
        else {
            processed_content = persist.serializable_from_instance(content);
        }
    }
    catch (error) {processed_content = persist.serializable_from_instance(error);}
    
    //  Apply necesary code and remove script element
    function client() {
        var id = ID;
        //  valid HTML within strings, so need to encode and decode front-end
        var attr = JSON.parse(decodeURIComponent(ATTR));
        var content = JSON.parse(decodeURIComponent(CONTENT));
        var element = $("#" + id);
        var script = $("#" + id + 'script');
        $(function () {
            var field;
            for (field in attr) {
                bind_attribute(element, field, attr[field]);
            }
            bind_html(element, content);
        });
        element.removeAttr('id');
        script.remove();
    }

    function serialize_attributes(from, into) {
        try {
            for (var field in from) {
                //  style value may be an object for css reasons
                if (field == 'style') {
                    //  TODO: handle if from.style is a reference
                    into.style = {};
                    serialize_attributes(from.style, into.style);
                }
                else {
                    // TODO: somehow warn object not valid
                    try {into[field] = persist.serializable_from_instance(from[field]);}
                    catch (error) {}            }
            }
        }
        catch (error) {
            //  TODO: somehow warn object not valid
        }
    }


    var id = "tmp_" + (Math.random() + '').slice(2);

    var new_attr = {};
    serialize_attributes(attributes, new_attr);
    attributes = new_attr;
    var client_source = '(' + client.toString()
        .replace("ATTR", '"' + encodeURIComponent(JSON.stringify(attributes)) + '"')
        .replace("CONTENT", '"' + encodeURIComponent(JSON.stringify(processed_content)) + '"')
        .replace("ID", '"'  + id + '"') + ')()';
    var script = '<script id="' + id + 'script" type="text/javascript">' + client_source + '</script>';
    return '<' + tag + ' id="' + id + '"></' + tag + '>' + script;
}
