var callchains = [];
var open_links = [];

module.exports.start = function (tag) {
    var start = process.hrtime();
    start = start[0] + start[1] * 1e-9;
    var link = {
        tag : tag,
        time : {
            self : 0,
            total : 0
        },
        children : []
    };
    if (open_links.length) {
        open_links[open_links.length-1].children.push(link);
    }
    else {
        callchains.push(link);
    }
    open_links.push(link)
    //  return the end function;
    return function () {
        var end = process.hrtime();
        end = end[0] + end[1] * 1e-9;
        var total_time = end - start;
        var child_time = 0;
        for (var i=0; i<link.children.length; i++) {
                child_time += link.children[i].time.total;
        }
        link.time.self  = total_time - child_time;
        link.time.total = total_time;
        open_links.pop();
    }
}

module.exports.report = function () {
    return JSON.stringify(callchains, null, 4);
}
