var proxies = require('./proxies');
var meta = require('./meta');
var get_persistant_proxy = require('./get_persistant_proxy');
var lock = require('./lock');
var scoped = require('./scoped');
var storage = require('storage');
var instance_from_serializable = require('./instance_from_serializable');


module.exports = load;

function load(id, callback) {
    var proxy = proxies[id];
    if (proxy) {
        if (meta.get(proxy).loaded) {
            if (callback) callback(null, proxies[id]);
        }
        else if (callback) {
            meta.get(proxy).onload.push(callback);
        }
        return proxy;
    }

    if (typeof id != 'string') throw new Error('get requires id');

    var proxy = get_persistant_proxy(id);

    meta.get(proxy).backup = true;

    if (callback) meta.get(proxy).onload.push(callback);

    function load_records() {
        //  load this proxy's history to get current state
        storage.exists(id, function (exists) {
            if (exists) {
                storage.get(id, function (err, res) {
                    if (err) {
                        callback(err);
                        return;
                    }
                    function handle_record(record) {
                        var value = instance_from_serializable(record.value);
                        if (value !== undefined) {
                            proxy[record.field] = value;
                        }
                        else delete proxy[record.field];
                    }
                    var data = res.toString();
                    var records = data.split('\n');
                    records.shift(); // first == ''
                    while (records.length) {
                        handle_record(JSON.parse(records.shift()));
                    }
                    meta.get(proxy).loaded = true;
                    var done = false;
                    function check_done() {
                        if (done) return;
                        var dependencies = meta.get(proxy).dependencies;
                        for (var i = 0; i < dependencies.length; i++) {
                            if(!meta.get(dependencies[i]).loaded) return;
                        }
                        done = true;
                        var onload = meta.get(proxy).onload;
                        for (var i = 0; i < onload.length; i++) {
                            onload[i](null, proxy);
                        }
                    }
                    check_done();
                });
            }
            else {
                //  execute the onload functions for the new proxy
                meta.get(proxy).loaded = true;
                var onload = meta.get(proxy).onload;
                for (var i = 0; i < onload.length; i++) {
                    onload[i](null, proxy);
                }
            }
        });
    }

    lock(id, function (err, res) {
        if (err) console.log(err);
        else     load_records();
    });
    return proxy;
}

