//  process must be started with --harmony flag
var net = require('net');

var File = require('files').File;
var error_report = require('./error_report');
var get_time = require('./get_time');
var get_type = require('./get_type');
var serializable_from_instance = require('./serializable_from_instance');
var instance_from_serializable = require('./instance_from_serializable');
var scoped = require('./scoped');
var get_persistant_proxy = require('./get_persistant_proxy');
var meta = require('./meta');
var send_to_watching = require('./send_to_watching');
var proxies = require('./proxies');
var events = require('./events');
var hash_reference = require('./hash_reference');
var unload = require('./unload');
var load = require('./load');
var create = require('./create');
var exists = require('./exists')
var watched_references = require('./watched_references');
var resolve_and_execute = require('./resolve_and_execute');
var responses = require('./responses');
var host_resolver = require('./host_resolver');
var JSONprotocol = require('./json_protocol');
var resolve_and_execute = require('./resolve_and_execute');

module.exports.handleWS      = handleWS;
module.exports.handleTCP     = handleTCP;
module.exports.identify      = identify;
module.exports.create        = create;
module.exports.unload        = unload;
module.exports.load          = load;
module.exports.is            = is;
module.exports.on            = events.on;
module.exports.exists        = exists;
module.exports.scoped        = scoped;
module.exports.resolve_hosts = host_resolver.set;
module.exports.resolve_and_execute = resolve_and_execute;
module.exports.instance_from_serializable = instance_from_serializable;

module.exports.set_agent = function (name) {
    root_agent = name;
}

module.exports.get_root_agent = function () {
    return root_agent;
}

var root_agent;

function handleWS(connection) {
    var respond = JSONprotocol(connection, connection.send);
    connection.on('message', respond);
    connection.on('close', close_connection(connection));
    connection.open = true;
}

function handleTCP(connection) {
    //  TODO: set proper requester (will be another persist instance)
    var requester = 'external tcp (persist) requester';
    var respond = JSONprotocol(connection, connection.write);
    connection.on('data', respond);
    connection.on('end', close_connection(connection));
    connection.open = true;
}

function close_connection(connection) {
    return function () {
        //  TODO: clean up watching infrastructure
        connection.open = false;
    }
}

function identify(persistant) {
    if (meta.has(persistant)) {
        var id = meta.get(persistant).id
        return id;
    }
    else {
        throw new Error('cannot identify non-persistant item');
    }
}

function is(proxy) {
    return meta.has(proxy);
}
//  TODO: serve historical version of object
