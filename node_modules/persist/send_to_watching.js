var hash_reference = require('./hash_reference');
var watched_references = require('./watched_references');
var serializable_from_instance = require('./serializable_from_instance');
var get_time = require('./get_time');

var updates_pending = {};

function send_to_watching(context, reference, serialized_value) {
    var hashed_ref = hash_reference(reference);
    var watching = watched_references[hashed_ref];
    if (watching) {
        //  overwrite existing update function if exists
        updates_pending[hashed_ref] = {
            serialized_value : serialized_value,
            time : get_time()
        }
        process.nextTick(function () {
            //  only execute update function once per process tick
            var update = updates_pending[hashed_ref];
            if (update) {
                delete updates_pending[hashed_ref];
                //  TODO: send original time along
                var update = JSON.stringify({
                    type : 'update',
                    reference : reference,
                    time : update.time,
                    value : serialized_value,
                    token : update.time
                });
                for (var i=0; i<watching.length; i++) {
                    //  if context is also watching this reference, it does not need to receive the update
                    if (context != watching[i] && watching[i].open) {
                        watching[i].respond.call(watching[i], '"""'  + update);
                    }
                }
            }
        });
    }
}

module.exports = send_to_watching;
