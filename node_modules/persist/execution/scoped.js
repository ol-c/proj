var vm = require('vm');
var environment = require('environment');
var persist = require('persist');
var references = require('references');
var records = require('../history/records');
var create = require('../containers/create');
var profile = require('profile');

function scoped(expression, object, agent) {
    var end = profile.start('scoped_expression');

    var custom_env = {};
    for (var field in environment) {
        custom_env[field] = environment[field];
    }
    //  attach custom environment
    //  create relative references
    var root = persist.get(persist.get_root());
    var reference = {
        root : references.relative('root', persist.identify(root)),
        this : references.relative('this', persist.identify(object))
    };
    custom_env.reference = reference;

    /*
    custom_env.eval = function(arg1) {
        return (function (arg1) {
            return eval(arg1);
        }).call(object, arg1);
    };

    custom_env.delay = function (time) {
        var promise = create('promise');
        setTimeout(function () {
            promise.fulfill();
        }, time);
        return promise;
    };*/

    custom_env._tmp_ = object;
    var trimmed = expression.replace(/(;|\s)*$/g, '');
    var to_return;
    //  add all items in root to custom env
    //  TODO: choose wether or not to expose all available system functions in root
    //        I think so! that way we have a way to document them and explore them in the same interface
    for (var field in root) {
        if (custom_env[field] === undefined) {
            custom_env[field] = root[field];
        }
    }
    //  TODO: disallow escaping function and executing arbitrary scripts
    try {
        vm.runInNewContext('function _tmp_() {return ' + trimmed + '}', custom_env);
    }
    catch (error) {
        vm.runInNewContext('function _tmp_() {' + trimmed + '}', custom_env);
    }
    var scoped_function = custom_env._tmp_;
    custom_env._tmp_ = scoped_function.call(object);

    end();

    return custom_env._tmp_;
}

module.exports = scoped;
