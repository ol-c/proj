var domain = require('domain');
var resolve_and_execute = require('./resolve_and_execute');
var error_report = require('./error_report');
var auth = require('auth');

module.exports = JSONprotocol;


//  handle request over JSON protocol
function JSONprotocol(context, respond) {
    //  TODO: gaurd against circular reference
    context.respond = respond;
    function send(response) {
        respond.call(context, '"""' + response);
    }
    return function (data) {
        //  sometimes multiple writes are lumped into data
        //  """ cannot occur in JSON so we append it to all
        //  JSON requests
        var operations = (data + '').split('"""');
        while (operations.length) {
            var operation = operations.shift();
            if (operation != '') {
                process_operation(context, operation, send);
            }
        }
    }
}

var client_tokens = {};

function process_operation(context, operation, send) {
    try {
        operation = JSON.parse(operation);
    }
    catch (error) {
        send(error_report('invalid JSON formatting received', true));
    }

    var d = domain.create();

    d.run(function () {
        var reference = operation.reference;
        //  only trust agent lists from TCP connections (those are under the security layer)
        if (context.type != 'websocket') {
            if (operation.agents) {
                for (var i=0; i<operation.agents.length; i++) {
                    auth.associate(operation.agents[i]);
                }
            }
        }
        else {
            auth.associate(auth.decode(context.session.id));
        }
        operation.agents = auth.authorizations();

        function done(error, value) {
            if (error) {
                value = error_report(error, false, reference);
            }
            value.token = operation.token;
            send(JSON.stringify(value));
        }

        resolve_and_execute(context, operation, done);
    });

    d.on('error', function (error) {
        var reference = operation.reference;
        var error_rep = error_report(error, true, reference);
        error_rep.token = operation.token;
        send(error_rep);
    });
}
