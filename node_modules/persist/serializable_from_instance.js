var get_type = require("./get_type");
var persist = require("persist");
var references = require('references');
var files = require('files');

function get_serializable(value, reference, callback) {
    var type = get_type(value);
    var serializable = {};
    serializable.type = type;
    serializable.reference = reference;
    if (type == 'hashmap') {
        serializable.data = {};
        var id = persist.identify(value);
        for (var field in value) {
            serializable.data[field] = [
                {name : id,    type : 'reference'},
                {name : field, type : 'reference'}
            ];
            if (persist.is(value[field])) {
                //  this is a mutable type
                //  therefore each instance needs an absolute
                //  reference
                serializable.data[field] = [{
                    type : 'reference',
                    name : persist.identify(value[field])
                }];
            }
        }
        serializable.reference = [{name : id, type : 'reference'}];
    }
    else if (type == 'list') {
        serializable.data = {
            length : value.length
        };
        var id = persist.identify(value);
        serializable.reference = [{name : id, type : 'reference'}];
    }
    else if (type == 'set') {
        serializable.data = {
            //  TODO: length of list and other metadata
        };
        var id = persist.identify(value);
        serializable.reference = [{name : id, type : 'reference'}];
    }
    else if (type == 'string' || type == 'boolean' || type == 'null') {
        serializable.data = value;
    }
    else if (type == 'number') {
        if (value == -Infinity) {
            serializable.data = "-Infinity";
        }
        else if (value == Infinity) {
            serializable.data = "Infinity";
        }
        else if (isNaN(value)) {
            serializable.data = "NaN";
        }
        else {
            serializable.data = value;
        }
    }
    else if (type == 'reference') {
        serializable.data = references.serializable(value);
    }
    else if (type == 'file') {
        serializable.data = files.serializable(value);
    }
    else if (type == 'function') {
        serializable.data = value.toString();
    }
    else if (value === undefined) {
        
    }
    else if (type == 'date') {
        serializable.data = value.toJSON();
    }
    else {
        var msg = value.toString() + ' is not serializable';
        if (callback) callback(msg);
        else throw new Error(msg);
        return;
    }
    if (callback) callback(null, serializable);
    else return serializable;
}

module.exports = get_serializable;
