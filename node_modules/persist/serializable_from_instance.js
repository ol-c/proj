var get_type = require("./get_type");
var persist = require("persist");

function get_serializable(value, reference, callback) {
        var type = get_type(value);
        var serializable = {};
        serializable.type = type;
        serializable.reference = reference;
        if (type == 'hashmap') {
            serializable.data = {};
            var id = persist.identify(value);
            for (var field in value) {
                serializable.data[field] = {
                    id       : id,
                    internal : field
                };
            }
        }
        else if (type == 'string' || type == 'boolean' || type == 'null') {
            serializable.data = value;
        }
        else if (type == 'number') {
            if (value == -Infinity) {
                serializable.data = "-Infinity";
            }
            else if (value == Infinity) {
                serializable.data = "Infinity";
            }
            else if (isNaN(value)) {
                serializable.data = "NaN";
            }
            else {
                serializable.data = value;
            }
        }
        else if (type == 'reference') {
            serializable.data = 'reference...';
        }
        else if (type == 'file') {
            serializable.data = 'file...';
        }
        else if (type == 'function') {
            serializable.data = value.toString();
        }
        else if (value === undefined) {
            
        }
        else if (type == 'date') {
            serializable.data = value.toISOString();
        }
        else {
            var msg = value + ' is not serializable';
            if (callback) callback(msg);
            else throw new Error(msg);
            return;
        }
        if (callback) callback(null, serializable);
        else return serializable;
}

module.exports = get_serializable;
