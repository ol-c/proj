var persist = require('persist');
var context = {};

var passed = 0;
var failed = 0;

var assert = function (condition, task) {
    if (condition) {
        passed++;
        console.log('    PASS', task);
    }
    else {
        failed++;
        console.log('    FAIL', task);
    }
}
var test_primatives = {
    bool_t : true,
    bool_f : false,
    string : 'test string',
    NULL : null,
    number : 123,
    fn : function () {
        //  TEST FUNCTION
        //  source strings must ===
        return 21;
    }
};

function check_test_primatives(object) {
    console.log(object);
    for (var field in test_primatives) {
        var actual = object[field];
        var expected = test_primatives[field];
        if (typeof test_primatives[field] == 'function') {
            actual = actual.toString();
            expected = expected.toString();
        }
        else console.log(actual, expected)
        assert(actual === expected, '"' + field + '" matches expected value');
    }
}

function add_test_primatives(object) {
    for (var field in test_primatives) {
        object[field] = test_primatives[field];
    }
}

function check_references(references, object) {
    for (var field in references) {
        assert(persist.identify(object[field]) === references[field], 'stored version of reference matches expected');
    }
}

/*

    TESTS

*/


function simple_primatives(next) {
    var a = persist.create('hashmap');
    add_test_primatives(a);
    check_test_primatives(a);

    var id = persist.identify(a);

    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            check_test_primatives(a);
            console.log('END simple primatives test');
            next();
        });
    });
}

function simple_references(next) {
    var a = persist.create('hashmap');
    a.child1 = persist.create('hashmap');
    a.child2 = persist.create('hashmap');
    a.child3 = persist.create('hashmap');

    var references = {
        child1 : persist.identify(a.child1),
        child2 : persist.identify(a.child2),
        child3 : persist.identify(a.child3)
    };

    check_references(references, a);
    
    var id = persist.identify(a);

    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            check_references(references, a);
            console.log('END simple references test');
            next();
        });
    });
}

function simple_circular_references(next) {
    var a = persist.create('hashmap');
    a.a = a;
    a.me = a;
    a.myself = a;

    var id = persist.identify(a);

    assert(a === a.a, 'set simple circular references');
    assert(a === a.me, 'set simple circular references');
    assert(a === a.myself, 'set simple circular references');

    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            assert(a === a.a, 'load simple circular references');
            assert(a === a.me, 'load simple circular references');
            assert(a === a.myself, 'load simple circular references');
            console.log('END simple circular references test');
            next();
        });
    });
}

function simple_circular_references_with_primatives(next) {
    var a = persist.create('hashmap');
    a.a = a;
    a.me = a;
    a.myself = a;

    add_test_primatives(a);

    var id = persist.identify(a);

    assert(a === a.a, 'set simple circular references');
    assert(a === a.me, 'set simple circular references');
    assert(a === a.myself, 'set simple circular references');

    check_test_primatives(a);


    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            assert(a === a.a, 'load simple circular references');
            assert(a === a.me, 'load simple circular references');
            assert(a === a.myself, 'load simple circular references');
            check_test_primatives(a);
            console.log('END simple circular references test');
            next();
        });
    });
}


function nested_circular_references(next) {
    var a = persist.create('hashmap');
    a.another = persist.create('hashmap');
    a.me = a;
    a.myself = a;
    a.another.a = a;

    var id = persist.identify(a);

    assert(a === a.me, 'set nested circular references');
    assert(a === a.myself, 'set nested circular references');
    assert(a === a.another.a, 'set nested circular references');
 
    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            assert(a === a.me, 'load nested circular references');
            assert(a === a.myself, 'load nested circular references');
            assert(a === a.another.a, 'load nested circular references');
            console.log('END nested circular references test');
            next();
        });
    });
}



function nested_circular_references_with_primatives(next) {
    var a = persist.create('hashmap');
    a.another = persist.create('hashmap');
    a.me = a;
    a.myself = a;
    a.another.a = a;

    var id = persist.identify(a);

    add_test_primatives(a);
    add_test_primatives(a.another);

    assert(a === a.me, 'set nested circular references');
    assert(a === a.myself, 'set nested circular references');
    assert(a === a.another.a, 'set nested circular references');

    check_test_primatives(a);
    check_test_primatives(a.another);


console.log(persist.identify(a));

    persist.unload(a, function (err) {
        assert(err === null, 'unload without error');
        persist.load(id, function (err, a) {
            assert(err === null, 'load without error');
            assert(a === a.me, 'load nested circular references');
            assert(a === a.myself, 'load nested circular references');
            assert(a === a.another.a, 'load nested circular references');
     
            check_test_primatives(a);
            check_test_primatives(a.another);

            console.log('END nested circular references test');
            next();
        });
    });
}


var tests = {
    'simple primatives' : simple_primatives,
    'simple references' : simple_references,
    'simple circular references' : simple_circular_references,
    'simple circular references with primatives' : simple_circular_references_with_primatives,
    'nested circular references' : nested_circular_references,
    'nested circular references with primatives' : nested_circular_references_with_primatives
}

var todo = Object.keys(tests);


function next() {
    if (todo.length) {
        var test = todo.shift();
        console.log('START', test);
        tests[test](next);
    }
    else {
        console.log('PASSED ' + passed + ' tasks');
        console.log('FAILED ' + failed + ' tasks');
    }
}

next();
