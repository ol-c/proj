var proxies = require('../meta/proxies');
var meta = require('../meta');
var containers = require('./index');
var lock = require('../meta/lock');
var scoped = require('../execution/scoped');
var storage = require('storage');
var instance_from_serializable = require('../serialization/instance_from_serializable');


module.exports = load;

function load(id, callback) {
    var proxy = proxies[id];
    if (proxy) {
        if (meta.get(proxy).loaded) {
            if (callback) callback(null, proxies[id]);
        }
        else if (callback) {
            meta.get(proxy).onload.push(callback);
        }
        return proxy;
    }

    if (typeof id != 'string') throw new Error('load requires id');
    var proxy = containers.create(undefined, id);

    meta.get(proxy).backup = true;

    if (callback) meta.get(proxy).onload.push(callback);

    function load_records() {
        //  load this proxy's history to get current state
        storage.exists(id, function (exists) {
            if (exists) {
                storage.get(id, function (err, res) {
                    if (err) {
                        callback(err);
                        return;
                    }
                    function handle_record(record) {
                        var target = proxies[record.id];
                        if (target === undefined) {
                            //  load persistant object if it hashn't been loaded yet
                            target = load(record.id);
                        }
                        if (record.meta) {
                            //  if operation is supposed to be
                            //  a meta operation, change target
                            //  to the meta object
                            target = meta.get(target);
                        }
                        if (record.operation == 'set') {
                            var value = instance_from_serializable(record.value, target);
                            if (value !== undefined) {
                                target[record.field] = value;
                            }
                            else delete proxy[record.field];
                        }
                        else if (record.operation == 'call') {
                            //  TODO: execute function...
                            var instantiated_args = [];
                            var args = record.arguments;
                            for (var i=0; i<args.length; i++) {
                                instantiated_args.push(instance_from_serializable(args[i]));
                            }
                            target[record.field].apply(target, instantiated_args);
                        }
                        else {
                            throw new Error('unrecognized operation: "' + record.operation + '"');
                        }
                    }
                    var data = res.toString();
                    var records = data.split('\n');
                    records.shift(); // first == ''
                    while (records.length) {
                        handle_record(JSON.parse(records.shift()));
                    }
                    loaded();
                });
            }
            else {
                // new object created
                loaded();
            }
        });
        function loaded() {
            meta.get(proxy).loaded = true;
            var onload = meta.get(proxy).onload;
            for (var i = 0; i < onload.length; i++) {
                onload[i](null, proxy);
            }
        }

    }

    lock(id, function (err, res) {
        if (err) console.log(err);
        else     load_records();
    });
    return proxy;
}

