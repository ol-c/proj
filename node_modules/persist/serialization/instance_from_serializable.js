
module.exports = instance_from_serializable;

var scoped = require('../execution/scoped');
var references = require('references')
var files = require('files');
var load = require('../containers/load');
var proxies = require('../meta/proxies');
var domain = require('domain');
var auth = require('auth');
var persist = require('persist');
var modules = require('modules');
var clients = require('clients');

//  take a serializable value and ble
function instance_from_serializable(value, container) {
    var unserialized;
    //  TODO: if value.data has unexpected form
    //        for type, throw an error
    if (value.type == 'string') {
        unserialized = value.data;
    }
    else if (value.type == 'hashmap') {
        //  TODO: need to be able to do this so we can reload
        var id = value.reference[0].name;
        if (proxies[id]) {
            unserialized = proxies[id];
        }
        else {
            //  should never make request for unloadable version
            unserialized = load(id);
        }
        //throw new Error('cannot create instance from serialized version of a container type');
    }
    else if (value.type == 'list') {
        var id = value.reference[0].name;
        if (proxies[id]) {
            unserialized = proxies[id];
        }
        else {
            unserialized = load(id);
        }
    }
    else if (value.type == 'promise') {
        var id = value.reference[0].name;
        if (proxies[id]) {
            unserialized = proxies[id];
        }
        else {
            unserialized = load(id);
        }
    }
    else if (value.type == 'set') {
        var id = value.reference[0].name;
        if (proxies[id]) {
            unserialized = proxies[id];
        }
        else {
            unserialized = load(id);
        }
    }
    else if (value.type == 'date') {
        unserialized = new Date(value.data);
    }
    else if (value.type == 'client') {
        unserialized = clients.Client(value.data.language, value.data.script);
    }
    else if (value.type == 'function') {
        //  expose the toolbox to all users
        unserialized = function () {
            var args = arguments;
            var d = domain.create();
            d.authorizations = auth.authorizations();
            var result;
            d.run(function () {
                auth.associate(persist.get_agent());
                result = scoped(value.data, container).apply(container, args);
            });
            return result;
        };
        unserialized.toString = function () {return value.data};
    }
    else if (value.type == 'boolean') {
        unserialized = value.data;
    }
    else if (value.type == 'null') {
        unserialized = null;
    }
    else if (value.type == 'number') {
        unserialized = parseFloat(value.data);
    }
    else if (value.type == 'reference') {
        unserialized = references.instance_from_serializable(value.data);
    }
    else if (value.type == 'file') {
        unserialized = new files.File(value.data.url);
    }
    else if (value.type == 'module') {
        unserialized = modules.loader[value.data.name];
    }
    else if (value.type == 'undefined') {
        unserialized = undefined;
    }
    else {
        throw new Error('cannot unserialize type: ' + value.type);
    }
    return unserialized;
}
