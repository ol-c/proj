var meta = require("./meta");
var proxies = require("./proxies");
var storage = require('storage');
var persist = require('persist');

var PERSIST_RECORD_DELAY = 10;

var all_pending = [];

function save(record) {
    var id = record.id;
    var pending = meta.get(proxies[id]).pending_records;
    if (pending == undefined) {
        pending = [];
        meta.get(proxies[id]).pending_records = pending;
    }
    if (meta.get(proxies[id]).persisting) {
        
    }
    else {
        meta.get(proxies[id]).persisting = true;
    }
    pending.push(record);
    all_pending.push(record);
}

function persist_records() {
    function next() {
        setTimeout(function () {
            persist_records();
        }, PERSIST_RECORD_DELAY);
    }

    if (all_pending.length) {
        var data = '';
        while (all_pending.length) {
            var record = all_pending.shift();
            console.log(record)
            var state = meta.get(proxies[record.id])
            state.pending_records.shift();
            if (state.pending_records.length == 0 && state.unloading) {
                state.unload();
            }
            data += '\n' + JSON.stringify(record);
        }
        storage.append(persist.get_root(), data, function (err) {
            if (err) console.log(err);
            next();
        });
    }
    else next();
}

setTimeout(persist_records, PERSIST_RECORD_DELAY);

function pending(proxy) {
    return meta.get(proxy).pending_records;
}

module.exports.save = save;
module.exports.pending = pending;
