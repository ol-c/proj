var vm = require('vm');
var environment = require('environment');
var persist = require('persist');
var references = require('references');
var containers = require('./get_persistant_proxy');
var records = require('./records');

function scoped(expression, object, agent) {
    var custom_env = {};
    for (var field in environment) {
        custom_env[field] = environment[field];
    }
    //  attach custom environment
    //  create relative references
    var reference = {
        root : references.relative('root', persist.get_root()),
        this : references.relative('this', persist.identify(object))
    };
    custom_env.reference = reference;
    custom_env.eval = function(arg1) {
        return (function (arg1) {
            return eval(arg1);
        }).call(object, arg1);
    };
    custom_env._tmp_ = object;
    var trimmed = expression.replace(/(;|\s)*$/g, '');
    var to_return;
    //  TODO: disallow escaping function and executing arbitrary scripts
    try {
        vm.runInNewContext('function _tmp_() {return ' + trimmed + '}', custom_env);
    }
    catch (error) {
        vm.runInNewContext('function _tmp_() {' + trimmed + '}', custom_env);
    }
    var scoped_function = custom_env._tmp_;
    custom_env._tmp_ = scoped_function.call(object);

    return custom_env._tmp_;
}

module.exports = scoped;
