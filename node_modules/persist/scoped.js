var vm = require('vm');
var environment = require('environment');
var authorize = require('authorize');

function scoped(expression, object, agent) {
    var custom_env = {};
    for (var field in environment) {
        custom_env[field] = environment[field];
    }
    custom_env.eval = function(arg1) {
        return (function (arg1) {
            return eval(arg1);
        }).call(object, arg1);
    };
    custom_env._tmp_ = object;
    var trimmed = expression.replace(/(;|\s)*$/g, '');
    try {
        vm.runInNewContext('function _tmp_() {return (' + trimmed + ')}', custom_env);
    }
    catch (error) {
        vm.runInNewContext('function _tmp_() {' + trimmed + '}', custom_env);
    }
    //  can use this reference to travel stack and associate agents with executed functions
    var scoped_function = custom_env._tmp_;
    authorize.associate(scoped_function, 'agent id');
    var to_return = scoped_function.call(object);
    if (typeof to_return == 'function') {
        authorize.associate(to_return, 'agent of created function');
    }
    return to_return;
}

module.exports = scoped;
