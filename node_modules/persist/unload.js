var meta = require('./meta');
var proxies = require('./proxies');
var unlock = require('./unlock');
var records = require('./records');

function unload(proxy, callback) {
    if (!meta.has(proxy)) {
        throw new Error('cannot unload non persistant item');
    }
    else if (meta.get(proxy).unloading) {
        throw new Error('already unloading');
    }

    var id   = meta.get(proxy).id;
    var deps = meta.get(proxy).dependencies;
 
    meta.get(proxy).unloading = true;

    var todo = 1;
    function done(err) {
        if (err) console.log(err);
        else     todo -= 1;
        
        if (todo == 0 && callback) callback(null);
    }

    for (var i=0; i<deps.length; i++) {
        if (meta.has(deps[i]) && !meta.get(deps[i]).unloading) {
            todo += 1;
            unload(deps[i], done);
        }
    }
    
    function perform_unload() {
        meta.delete(proxy);
        delete proxies[id];
        unlock(id, done);
    }

    if (records.pending(proxy).length) {
        meta.get(proxy).onunload = perform_unload
    }
    else {
        perform_unload();
    }

    
}

module.exports = unload;
