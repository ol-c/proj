var meta = require("./meta");
var proxies = require("./proxies");
var fs = require('fs');

var PERSIST_RECORD_DELAY = 1000;

function save_record(record) {
    var id = record.id;
    var pending = meta.get(proxies[id]).pending_records;
    if (meta.get(proxies[id]).persisting) {}
    else {
        meta.get(proxies[id]).persisting = true;
        persist_records(proxies[id]);
    }
    pending.push(record);
}

function persist_records(proxy) {
    function next() {
        setTimeout(function () {
            persist_records(proxy);
        }, PERSIST_RECORD_DELAY);
    }

    var state = meta.get(proxy);
    var pending = state.pending_records;

    if (pending.length) {
        var data = '';
        while (pending.length) {
            var s = JSON.stringify(pending.shift());
            data += '\n' + s;
        }
        fs.appendFile('/persist/' + state.id, data, function (err) {
            if (err) console.log(err);
            next();
        });
    }
    else if (state.unloading) state.onunload();
    else                      next();
}

module.exports = save_record;
